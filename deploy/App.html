<!DOCTYPE html>
<html>
<head>
    <title>portfolio-timesheet-export</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.3.1/moment.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",itemId:"app",cache:[],items:[{itemId:"panel",xtype:"panel",layout:"column",items:[{name:"intervalType",xtype:"combo",store:Ext.create("Ext.data.ArrayStore",{fields:["interval"],data:[["Today"],["This Week"],["Last Week"],["This Month"],["Last Month"]]}),valueField:"interval",displayField:"interval",queryMode:"local",forceSelection:!0,boxLabelAlign:"after",fieldLabel:"Interval",margin:"5 5 5 5",listeners:{scope:this,select:function(list,item){var panel=_.first(Ext.ComponentQuery.query("#panel")),startDateCmp=panel.down("#startDate"),endDateCmp=panel.down("#endDate"),start,end;switch(_.first(item).get("interval")){case"Today":start=moment().startOf("day").toDate(),end=moment().endOf("end").toDate();break;case"This Week":start=moment().startOf("week").toDate(),end=moment().endOf("week").toDate();break;case"Last Week":start=moment().subtract(1,"week").startOf("week").toDate(),end=moment().subtract(1,"week").endOf("week").toDate();break;case"This Month":start=moment().startOf("month").toDate(),end=moment().endOf("month").toDate();break;case"Last Month":start=moment().subtract(1,"month").startOf("month").toDate(),end=moment().subtract(1,"month").endOf("month").toDate()}startDateCmp.setValue(start),startDateCmp.getValue(),endDateCmp.setValue(end),endDateCmp.getValue(),app._onSelect()}}},{itemId:"startDate",margin:"5 5 5 5",xtype:"datefield",fieldLabel:"Start Date",value:new Date},{itemId:"endDate",margin:"5 5 5 5",xtype:"datefield",fieldLabel:"End Date",value:new Date},{itemId:"exportButton",margin:"5 5 5 5",xtype:"rallybutton",text:"Export",handler:function(){var grid=app.down("#grid"),link=app.down("#exportLink");link.update(app.exporter.exportGrid(grid))}},{itemId:"exportLink",margin:"12 0 0 10"}]}],launch:function(){app=this,this._onLoad()},timeEntryItemColumn:{text:"Time Entry Item",width:100,renderer:function(value,metaData,record,rowIdx,colIdx,store,view){var item=record.get("TimeEntryItemObject");return item?item.get("WorkProductDisplayString"):""}},projectColumn:{text:"Project",renderer:function(value,metaData,record,rowIdx,colIdx,store,view){var item=record.get("TimeEntryItemObject");return item?item.get("ProjectDisplayString"):""}},epicColumn:{text:"Epic",renderer:function(value,metaData,record,rowIdx,colIdx,store,view){var item=record.get("EpicObject");return item?item.get("FormattedID")+":"+item.get("Name"):""}},featureColumn:{text:"Feature",renderer:function(value,metaData,record,rowIdx,colIdx,store,view){var item=record.get("FeatureObject");return item?item.get("FormattedID")+":"+item.get("Name"):""}},taskColumn:{text:"Task",width:100,renderer:function(value,metaData,record,rowIdx,colIdx,store,view){var item=record.get("TimeEntryItemObject");return item?item.get("TaskDisplayString"):""}},userColumn:{text:"User",width:100,renderer:function(value,metaData,record,rowIdx,colIdx,store,view){var item=record.get("TimeEntryItemObject");return item?item.get("User")._refObjectName:""}},_onLoad:function(){app.exporter=Ext.create("GridExporter");var cols=[{dataIndex:"DateVal",text:"Date"},app.projectColumn,app.timeEntryItemColumn,app.taskColumn,app.userColumn,"Hours","LastUpdated",{dataIndex:"TimeEntryItem",text:"TimeEntryItem",hidden:!0},app.epicColumn,app.featureColumn];this.add({xtype:"rallygrid",itemId:"grid",columnCfgs:cols,context:this.getContext(),storeConfig:{model:"TimeEntryValue"},listeners:{load:function(rows){var values=rows.data.items;app.readTimeEntryItems(values).then({success:function(items){console.log("items",items),app.setValues(values,items,"TimeEntryItemObject"),app.loadStories(items).then({success:function(stories){console.log("stories",stories),app.setValues(values,stories,"StoryObject"),app.readFeatures(stories).then({success:function(features){console.log("features",features),app.setValues(values,features,"FeatureObject"),app.readEpics(features).then({success:function(epics){console.log("epics",epics),app.setValues(values,epics,"EpicObject")}})}})}})}})}}})},setValues:function(items,values,attrName){_.each(items,function(item,x){item.set(attrName,values[x])})},readObject:function(model,ref){var deferred=Ext.create("Deft.Deferred"),obj=_.find(app.cache,function(cacheObj){return cacheObj.ref._ref===ref._ref?cacheObj.promise.promise:void 0});return _.isUndefined(obj)||_.isNull(obj)?(Rally.data.ModelFactory.getModel({type:model,success:function(model){model.load(ref,{fetch:!0,callback:function(result,operation){deferred.resolve(result)}})}}),app.cache.push({ref:ref,promise:deferred}),deferred.promise):obj.promise.promise},loadStories:function(items){var promises=_.map(items,function(item){var deferred=Ext.create("Deft.Deferred"),workProductRef=item.get("WorkProduct");return null===workProductRef||"HierarchicalRequirement"!==workProductRef._type?deferred.resolve(null):app.readObject("HierarchicalRequirement",workProductRef).then({success:function(obj){deferred.resolve(obj)}}),deferred.promise});return Deft.Promise.all(promises)},readTimeEntryItems:function(values){var promises=_.map(values,function(v){var deferred=Ext.create("Deft.Deferred"),ref=v.get("TimeEntryItem");return app.readObject("TimeEntryItem",ref).then({success:function(obj){deferred.resolve(obj)}}),deferred.promise});return Deft.Promise.all(promises)},readFeatures:function(stories){var promises=_.map(stories,function(story){var deferred=Ext.create("Deft.Deferred");if(_.isNull(story)||_.isUndefined(story.get("Feature"))||_.isNull(story.get("Feature")))deferred.resolve(null);else{var featureRef=story.get("Feature");app.readObject("PortfolioItem/Feature",featureRef).then({success:function(obj){deferred.resolve(obj)}})}return deferred.promise});return Deft.Promise.all(promises)},readEpics:function(features){var promises=_.map(features,function(feature){var deferred=Ext.create("Deft.Deferred");if(_.isNull(feature)||_.isUndefined(feature.get("Parent"))||_.isNull(feature.get("Parent")))deferred.resolve(null);else{var epicRef=feature.get("Parent");app.readObject("PortfolioItem/Initiative",epicRef).then({success:function(obj){deferred.resolve(obj)}})}return deferred.promise});return Deft.Promise.all(promises)},_getDateFilter:function(){var panel=_.first(Ext.ComponentQuery.query("#panel")),startDateCmp=panel.down("#startDate").getValue(),endDateCmp=panel.down("#endDate").getValue(),start=Rally.util.DateTime.toIsoString(startDateCmp,!1),end=Rally.util.DateTime.toIsoString(endDateCmp,!1);return[{property:"DateVal",operator:">=",value:start},{property:"DateVal",operator:"<=",value:end}]},_onSelect:function(){var grid=app.down("rallygrid"),store=grid.getStore();store.clearFilter(!0),store.filter(app._getDateFilter())},_onSelectDate:function(a,b,c){console.log(a,b,c)},_export:function(){var grid=this.down("rallygrid"),me=this;if(grid){this.logger.log("_export",grid);var filename=Ext.String.format("user-permissions.csv");this.setLoading("Generating CSV"),Deft.Chain.sequence([function(){return Rally.technicalservices.FileUtilities._getCSVFromCustomBackedGrid(grid)}]).then({scope:this,success:function(csv){csv&&csv.length>0?Rally.technicalservices.FileUtilities.saveCSVToFile(csv,filename):Rally.ui.notify.Notifier.showWarning({message:"No data to export"})}}).always(function(){me.setLoading(!1)})}}});
                Ext.define("GridExporter",{dateFormat:"Y-m-d",exportGrid:function(grid){if(!Ext.isIE){var data=this._getCSV(grid);return"<a href='data:text/csv;charset=utf8,"+encodeURIComponent(data)+"' download='export.csv'>Click to download file</a>"}this._ieToExcel(grid)},_escapeForCSV:function(string){return string=""+string,string.match(/,/)&&(string=string.match(/"/)?string.replace(/,/g,""):'"'+string+'"'),string},_getFieldText:function(fieldData,record,col,index){var text;return console.log(col),_.isUndefined(col)||"Project"!==col.text?_.isUndefined(col)||"Time Entry Item"!==col.text?_.isUndefined(col)||"Task"!==col.text?_.isUndefined(col)||"User"!==col.text?_.isUndefined(col)||"Epic"!==col.text?_.isUndefined(col)||"Feature"!==col.text?text=col&&"renderTotalComponentValuePreliminaryEstimate"===col.renderType?app.renderer.renderTotalComponentValuePreliminaryEstimate(fieldData,0,record,0,index):null==fieldData||void 0==fieldData?"":fieldData._refObjectName&&!fieldData.getMonth?fieldData._refObjectName:fieldData instanceof Date?Ext.Date.format(fieldData,this.dateFormat):fieldData:record.get("FeatureObject")?record.get("FeatureObject").get("FormattedID")+":"+record.get("FeatureObject").get("Name"):"":record.get("EpicObject")?record.get("EpicObject").get("FormattedID")+":"+record.get("EpicObject").get("Name"):"":record.get("TimeEntryItemObject").get("User")._refObjectName:record.get("TimeEntryItemObject").get("TaskDisplayString"):record.get("TimeEntryItemObject").get("WorkProductDisplayString"):record.get("TimeEntryItemObject").get("Project")._refObjectName},_getFieldTextAndEscape:function(fieldData,record,col,index){var string=this._getFieldText(fieldData,record,col,index);return this._escapeForCSV(string)},fixedColumnCount:function(columns){var cols=_.filter(columns,function(c){return void 0!==c&&null!==c&&1==c.locked});return cols.length},_getCSV:function(grid){var cols=grid.columns,store=grid.store,data="";console.log("cols",cols);var that=this;return Ext.Array.each(cols,function(col,index){if(1!=col.hidden){var colLabel=(0===index?"Item ":"")+col.text;colLabel=colLabel.replace(/<br\/?>/,""),data+=that._getFieldTextAndEscape(colLabel)+","}}),data+="\n",_.each(store.data.items,function(record){Ext.Array.each(cols,function(col,index){if(1!=col.hidden){var fieldName=col.dataIndex,text=record.get(fieldName);data+=that._getFieldTextAndEscape(text,record,col,index)+","}}),data+="\n"}),data},_ieGetGridData:function(grid,sheet){var that=this,resourceItems=grid.store.data.items,cols=grid.columns;Ext.Array.each(cols,function(col,colIndex){1!=col.hidden&&(sheet.cells(1,colIndex+1).value=col.text)});var rowIndex=2;grid.store.each(function(record){var entry=record.getData();Ext.Array.each(cols,function(col,colIndex){if(1!=col.hidden){var fieldName=col.dataIndex,text=entry[fieldName],value=that._getFieldText(text);sheet.cells(rowIndex,colIndex+1).value=value}}),rowIndex++})},_ieToExcel:function(grid){if(window.ActiveXObject){var xlApp,xlBook;try{xlApp=new ActiveXObject("Excel.Application"),xlBook=xlApp.Workbooks.Add()}catch(e){return Ext.Msg.alert("Error",'For the export to work in IE, you have to enable a security setting called "Initialize and script ActiveX control not marked as safe" from Internet Options -> Security -> Custom level..."'),void 0}xlBook.worksheets("Sheet1").activate;var XlSheet=xlBook.activeSheet;xlApp.visible=!0,this._ieGetGridData(grid,XlSheet),XlSheet.columns.autofit}}});

            Rally.launchApp('CustomApp', {
                name:"portfolio-timesheet-export",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
